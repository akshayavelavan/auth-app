<script>
const API_URL = "https://auth-app-1-cq6l.onrender.com/api/dashboard"; // your Render backend
const token = localStorage.getItem("token");

if (!token) {
  window.location.href = "index.html"; // redirect if no token
}

async function loadDashboard() {
  try {
    const res = await fetch(API_URL, {
      headers: {
        "Authorization": "Bearer " + token
      }
    });

    console.log("Dashboard response status:", res.status); // debug
    const data = await res.json();
    console.log("Dashboard data:", data); // debug

    if (!res.ok) {
      // If token invalid, clear it and redirect
      localStorage.removeItem("token");
      window.location.href = "index.html";
      return;
    }

    // Populate dashboard fields safely
    const email = data.user?.email || "User";
    document.getElementById("welcome-text").innerText = `Welcome, ${email}!`;
    document.getElementById("user-email").innerText = email;
    document.getElementById("login-time").innerText = new Date(data.serverTime).toLocaleString();
    document.getElementById("session-status").innerText = "Active";

    // Activity list
    const activityList = data.activity?.map(a => `${a.action} - ${new Date(a.time).toLocaleString()}`) || [
      "JWT Token verified",
      "Password hashed with bcrypt",
      "Rate limiting enabled",
      "Secure API route accessed"
    ];

    const ul = document.getElementById("activity-list");
    ul.innerHTML = "";
    activityList.forEach(act => {
      const li = document.createElement("li");
      li.textContent = act;
      ul.appendChild(li);
    });

  } catch (err) {
    console.error("Dashboard fetch error:", err);
    localStorage.removeItem("token");
    window.location.href = "index.html";
  }
}

// Load dashboard on page load
loadDashboard();

// Logout button
document.getElementById("logout-btn").addEventListener("click", () => {
  localStorage.removeItem("token");
  window.location.href = "index.html";
});
</script>
